version: '3.8'
services:
  backend:
    build: ./backend
    # Host port can be overridden with the BACKEND_PORT env var (default 8080)
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      # Verbose tracing in backend to capture deep decode diagnostics
      - RUST_LOG=${RUST_LOG:-debug}
      # Pass-through keys and debugging toggles (set in your shell before `docker compose up`)
      - LORA_SECRET_KEY=${LORA_SECRET_KEY}
      - LORA_SIGN_TOKEN=${LORA_SIGN_TOKEN}
      # When set to 1/true, logs full keys (not masked). Use only during controlled debug windows.
      - LOG_KEYS_FULL=${LOG_KEYS_FULL:-0}
      # Enable ECB-without-unpad fallback to capture frames when devices don't pad
      - LORA_DECODE_FALLBACK=${LORA_DECODE_FALLBACK:-0}
      # Continue parsing even if HMAC doesn't match (debug only)
      - LORA_ALLOW_HMAC_MISMATCH=${LORA_ALLOW_HMAC_MISMATCH:-0}
  # Pass the frontend host port into the container so the server
  # can construct the correct allowed CORS origin for the demo frontend.
  # Do NOT pass BACKEND_PORT here â€“ the server should bind to the
  # container-internal port 8080 and docker will map the host port.
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}

  frontend:
    build: ./frontend
    # Host port can be overridden with the FRONTEND_PORT env var (default 3000)
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - backend